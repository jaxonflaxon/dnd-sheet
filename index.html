<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 2024 Character Sheet</title>
    <style>
        /* --- STYLING (The Look) --- */
        body { font-family: sans-serif; background-color: #1a1a1a; color: #eee; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Grid Layout */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* Sections */
        .section { background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
        h2 { border-bottom: 2px solid #555; padding-bottom: 5px; margin-top: 0; color: #ffa500; }
        
        /* Inputs */
        input, select, textarea { background: #333; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        input[type="number"] { text-align: center; font-weight: bold; }
        
        /* --- HEADER / BUTTONS --- */
        .btn-group { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
            /* This makes it stick to the top */
            position: sticky; 
            top: 0; 
            background: #1a1a1a; 
            padding: 15px 0; 
            z-index: 100; 
            border-bottom: 2px solid #333;
        }
        
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; color: white; }
        
        .btn-short { background-color: #d97706; } /* Orange */
        .btn-long { background-color: #2563eb; }  /* Blue */
        
        .btn-save { 
            background-color: #16a34a; /* Green */
            margin-left: auto; /* This pushes the Save button to the far right */
        }

        /* --- ATTRIBUTES STYLING --- */
        .stat-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 10px; 
            padding: 5px;
            background: #252525; /* Slight background to separate rows */
            border-radius: 5px;
        }
        
        /* Column Widths */
        .stat-name  { width: 110px; font-weight: bold; }
        .stat-score { width: 60px; margin-right: 10px; }
        .stat-mod   { width: 40px; font-weight: bold; color: #4ade80; text-align: center; margin-right: 20px;}
        
        /* Saving Throw Section */
        .save-group { display: flex; align-items: center; gap: 5px; border-left: 1px solid #444; padding-left: 15px; }
        .save-label { font-size: 0.8em; color: #aaa; margin-right: 5px; }
        .save-total { width: 40px; text-align: center; font-weight: bold; color: #60a5fa; } /* Blue for saves */
        
        /* This forces the Name (e.g., Strength) to be exactly 140px wide */
        .stat-row span:first-child {
            width: 140px; 
            font-weight: bold;
            display: inline-block; /* Essential for width to work on spans */
        }

        /* Adds spacing between the input box and the green modifier */
        .stat-row input {
            margin-right: 15px; 
        }

        .mod-box { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: #4ade80; 
            width: 40px; 
            text-align: center; 
        }
        /* --- SKILLS STYLING (Fixed Alignment) --- */
        .skill-row { 
            display: flex; 
            align-items: center; 
            padding: 5px 0; 
            border-bottom: 1px solid #333; 
            font-size: 0.9em;
        }
        /* Columns with fixed widths */
        .col-name { width: 150px; flex-shrink: 0; }
        .col-total { width: 50px; text-align: center; font-weight: bold; color: #4ade80; margin-right: 10px;}
        .col-check { width: 40px; display: flex; justify-content: center; margin-right: 5px; }
        .col-misc  { width: 60px !important; text-align: center; }
        
        .tiny-label { font-size: 0.7em; color: #888; margin-left: 5px; }
        
        /* --- WEAPON STYLING --- */
        .weapon-card { 
            background: #222; 
            border: 1px solid #444; 
            padding: 10px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            position: relative;
        }
        
        /* The Top Row (Name, Range, Type) */
        .weapon-top { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 10px; 
        }

        /* The Bottom Row (Calculations) */
        .weapon-bot { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: #1a1a1a; 
            padding: 8px; 
            border-radius: 5px; 
            border: 1px solid #333;
        }

        /* The "To Hit" Big Number */
        .hit-badge { 
            background: #dc2626; /* Red for attack */
            color: white; 
            padding: 5px 12px; 
            border-radius: 4px; 
            font-weight: bold; 
            font-size: 1.1em;
            min-width: 40px;
            text-align: center;
        }

        /* Delete Button (Red X) */
        .btn-del {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            border: 2px solid #1a1a1a;
            font-size: 0.8em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>D&D 2024 Character Sheet</h1>
    
    <div class="btn-group">
        <button class="btn-short" onclick="takeRest('short')">Short Rest</button>
        <button class="btn-long" onclick="takeRest('long')">Long Rest</button>
        
        <div style="margin-left: auto; display: flex; gap: 10px;">
            <button class="btn-save" style="background:#555;" onclick="exportCharacter()">⬇ Export</button>
            <button class="btn-save" style="background:#555;" onclick="document.getElementById('file-input').click()">⬆ Load</button>
            <button class="btn-save" onclick="saveData()">Save Local</button>
        </div>

        <input type="file" id="file-input" style="display: none;" onchange="importCharacter(this)">
    </div>
    
    <div class="section">
        <div class="grid-box">
            <div>
                <label>Character Name</label>
                <input type="text" id="charName" placeholder="Enter Name">
            </div>
            <div>
                <label>Class & Level</label>
                <input type="text" id="charClass" placeholder="e.g. Fighter 3">
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Vitals</h2>
        <div class="grid-box">
            <div>
                <label>Armor Class (AC)</label>
                <input type="number" id="ac" value="10">
            </div>
            <div>
                <label>Initiative</label>
                <input type="number" id="init" value="0">
            </div>
            
            <div>
                <label>Speed</label>
                <input type="text" id="speed" value="30 ft">
            </div>
            <div>
                <label>Proficiency Bonus</label>
                <input type="number" id="profBonus" value="2" oninput="calcMods()">
            </div>

            <div>
                <label>Current / Max HP</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="curHp" placeholder="Cur"> <span>/</span> 
                    <input type="number" id="maxHp" placeholder="Max">
                </div>
            </div>
            <div>
                <label>Temporary HP</label>
                <input type="number" id="tempHp" placeholder="0">
            </div>
            
            <div>
                <label>Hit Dice</label>
                 <div style="display:flex; gap:5px;">
                    <input type="number" id="hdCur" placeholder="Cur"> <span>/</span> 
                    <input type="text" id="hdMax" placeholder="Max (e.g. 1d10)">
                </div>
            </div>
        </div>
    </div>

   <div class="section">
        <h2>Attributes & Saving Throws</h2>
        
        <div style="display:flex; font-size:0.7em; color:#888; margin-bottom:5px; padding-left:5px;">
            <span style="width:110px;">Name</span>
            <span style="width:70px;">Score</span>
            <span style="width:60px;">Mod</span>
            <span style="padding-left:15px;">Saving Throw</span>
        </div>

        <div class="stat-row">
            <span class="stat-name">Strength</span>
            <input type="number" id="strScore" value="10" class="stat-score" oninput="calcMods()">
            <span class="stat-mod" id="strMod">+0</span>
            
            <div class="save-group">
                <input type="checkbox" id="str-save-prof" onchange="calcMods()">
                <span class="save-label">Save</span>
                <span class="save-total" id="str-save">+0</span>
            </div>
        </div>

        <div class="stat-row">
            <span class="stat-name">Dexterity</span>
            <input type="number" id="dexScore" value="10" class="stat-score" oninput="calcMods()">
            <span class="stat-mod" id="dexMod">+0</span>
            
            <div class="save-group">
                <input type="checkbox" id="dex-save-prof" onchange="calcMods()">
                <span class="save-label">Save</span>
                <span class="save-total" id="dex-save">+0</span>
            </div>
        </div>

        <div class="stat-row">
            <span class="stat-name">Constitution</span>
            <input type="number" id="conScore" value="10" class="stat-score" oninput="calcMods()">
            <span class="stat-mod" id="conMod">+0</span>
            
            <div class="save-group">
                <input type="checkbox" id="con-save-prof" onchange="calcMods()">
                <span class="save-label">Save</span>
                <span class="save-total" id="con-save">+0</span>
            </div>
        </div>

        <div class="stat-row">
            <span class="stat-name">Intelligence</span>
            <input type="number" id="intScore" value="10" class="stat-score" oninput="calcMods()">
            <span class="stat-mod" id="intMod">+0</span>
            
            <div class="save-group">
                <input type="checkbox" id="int-save-prof" onchange="calcMods()">
                <span class="save-label">Save</span>
                <span class="save-total" id="int-save">+0</span>
            </div>
        </div>

        <div class="stat-row">
            <span class="stat-name">Wisdom</span>
            <input type="number" id="wisScore" value="10" class="stat-score" oninput="calcMods()">
            <span class="stat-mod" id="wisMod">+0</span>
            
            <div class="save-group">
                <input type="checkbox" id="wis-save-prof" onchange="calcMods()">
                <span class="save-label">Save</span>
                <span class="save-total" id="wis-save">+0</span>
            </div>
        </div>

        <div class="stat-row">
            <span class="stat-name">Charisma</span>
            <input type="number" id="chaScore" value="10" class="stat-score" oninput="calcMods()">
            <span class="stat-mod" id="chaMod">+0</span>
            
            <div class="save-group">
                <input type="checkbox" id="cha-save-prof" onchange="calcMods()">
                <span class="save-label">Save</span>
                <span class="save-total" id="cha-save">+0</span>
            </div>
        </div>
    </div>
<div class="section">
        <h2>Skills</h2>
        <div class="skill-row" style="border:none; color:#aaa; font-size:0.8em; padding-bottom:0;">
            <div class="col-name">Skill Name</div>
            <div class="col-total" style="color:#aaa;">Total</div>
            <div class="col-check">Prof</div>
            <div class="col-check">Exp</div>
            <div class="col-misc">Misc</div>
        </div>
        
        <div id="skills-container">
            </div>
    </div>
<div class="section">
        <h2>Weapons</h2>
        <div id="weapon-list">
            </div>
        <button onclick="addWeapon()" style="background:#444; width:100%; margin-top:10px;">+ Add New Weapon</button>
    </div>
</div>

<script>
    
    // Global list of weapons
    let weapons = [];
    
    // --- WEAPON LOGIC ---

    function renderWeapons() {
        const container = document.getElementById('weapon-list');
        container.innerHTML = ""; // Clear current list

        weapons.forEach((w, index) => {
            // Calculate To Hit immediately for display
            const attrScore = document.getElementById(w.attr + 'Score').value || 10;
            const mod = Math.floor((attrScore - 10) / 2);
            const profBonus = parseInt(document.getElementById('profBonus').value) || 2;
            
            let hitTotal = mod + parseInt(w.bonus);
            if(w.prof) hitTotal += profBonus;
            const hitSign = hitTotal >= 0 ? "+" : "";

            // Create the HTML
            const html = `
            <div class="weapon-card">
                <button class="btn-del" onclick="removeWeapon(${index})">X</button>
                
                <div class="weapon-top">
                    <div><label class="tiny-label">Name</label><input type="text" value="${w.name}" oninput="updateWeapon(${index}, 'name', this.value)"></div>
                    <div><label class="tiny-label">Range</label><input type="text" value="${w.range}" oninput="updateWeapon(${index}, 'range', this.value)"></div>
                    <div><label class="tiny-label">Hand</label>
                        <select onchange="updateWeapon(${index}, 'hand', this.value)">
                            <option value="1H" ${w.hand === '1H' ? 'selected' : ''}>1H</option>
                            <option value="2H" ${w.hand === '2H' ? 'selected' : ''}>2H</option>
                        </select>
                    </div>
                    <div><label class="tiny-label">Type</label><input type="text" value="${w.type}" oninput="updateWeapon(${index}, 'type', this.value)"></div>
                </div>

                <div class="weapon-bot">
                    <div style="display:flex; flex-direction:column; width: 60px;">
                        <span class="tiny-label">Attr</span>
                        <select onchange="updateWeapon(${index}, 'attr', this.value); renderWeapons();">
                            <option value="str" ${w.attr === 'str' ? 'selected' : ''}>STR</option>
                            <option value="dex" ${w.attr === 'dex' ? 'selected' : ''}>DEX</option>
                            <option value="int" ${w.attr === 'int' ? 'selected' : ''}>INT</option>
                            <option value="wis" ${w.attr === 'wis' ? 'selected' : ''}>WIS</option>
                            <option value="cha" ${w.attr === 'cha' ? 'selected' : ''}>CHA</option>
                        </select>
                    </div>
                    
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span class="tiny-label">Prof?</span>
                        <input type="checkbox" ${w.prof ? 'checked' : ''} onchange="updateWeapon(${index}, 'prof', this.checked); renderWeapons();">
                    </div>

                    <div style="display:flex; flex-direction:column; width: 50px;">
                        <span class="tiny-label">Misc</span>
                        <input type="number" value="${w.bonus}" oninput="updateWeapon(${index}, 'bonus', this.value); renderWeapons();">
                    </div>

                    <div style="margin-left:auto; text-align:right;">
                        <div class="tiny-label">TO HIT</div>
                        <div class="hit-badge">${hitSign}${hitTotal}</div>
                    </div>

                    <div style="width: 100px;">
                         <span class="tiny-label">Damage</span>
                         <input type="text" value="${w.dmg}" placeholder="1d8+3" oninput="updateWeapon(${index}, 'dmg', this.value)">
                    </div>
                </div>
            </div>
            `;
            container.innerHTML += html;
        });
    }

    function addWeapon() {
        // Add a default blank weapon
        weapons.push({
            name: "New Weapon",
            range: "5ft",
            hand: "1H",
            type: "Slashing",
            attr: "str",
            prof: true,
            bonus: 0,
            dmg: ""
        });
        renderWeapons();
    }

    function removeWeapon(index) {
        if(confirm("Delete this weapon?")) {
            weapons.splice(index, 1);
            renderWeapons();
        }
    }

    function updateWeapon(index, field, value) {
        weapons[index][field] = value;
        // Note: We don't re-render here for text inputs to keep focus, 
        // but we do re-render for checkboxes/selects in the HTML above.
    }
    
    // --- CONFIGURATION ---
    const skillList = [
        { name: "Acrobatics", attr: "dex" },
        { name: "Animal Handling", attr: "wis" },
        { name: "Arcana", attr: "int" },
        { name: "Athletics", attr: "str" },
        { name: "Deception", attr: "cha" },
        { name: "History", attr: "int" },
        { name: "Insight", attr: "wis" },
        { name: "Intimidation", attr: "cha" },
        { name: "Investigation", attr: "int" },
        { name: "Medicine", attr: "wis" },
        { name: "Nature", attr: "int" },
        { name: "Perception", attr: "wis" },
        { name: "Performance", attr: "cha" },
        { name: "Persuasion", attr: "cha" },
        { name: "Religion", attr: "int" },
        { name: "Sleight of Hand", attr: "dex" },
        { name: "Stealth", attr: "dex" },
        { name: "Survival", attr: "wis" }
    ];

    // --- INITIALIZATION ---
    // 1. Build the Skill Rows automatically (Updated with new layout)
    function initSkills() {
        const container = document.getElementById('skills-container');
        let html = '';
        
        skillList.forEach(skill => {
            const id = skill.name.replace(/\s+/g, '').toLowerCase(); 
            
            html += `
            <div class="skill-row">
                <div class="col-name">
                    ${skill.name} <span class="tiny-label">(${skill.attr.substring(0,3).toUpperCase()})</span>
                </div>
                
                <div class="col-total" id="${id}-total">+0</div>
                
                <div class="col-check">
                    <input type="checkbox" id="${id}-prof" onchange="calcSkills()">
                </div>

                <div class="col-check">
                    <input type="checkbox" id="${id}-exp" onchange="calcSkills()">
                </div>

                <div class="col-misc">
                    <input type="number" id="${id}-misc" placeholder="0" oninput="calcSkills()">
                </div>
            </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // --- CALCULATIONS ---

    // 2. Calculate Attribute Modifiers AND Saving Throws
    function calcMods() {
        const stats = ['str', 'dex', 'con', 'int', 'wis', 'cha']; 
        const profBonus = parseInt(document.getElementById('profBonus').value) || 2;
        
        stats.forEach(stat => {
            const scoreInput = document.getElementById(stat + 'Score');
            
            if (scoreInput) {
                // 1. Calculate the Base Modifier
                const score = parseInt(scoreInput.value) || 10;
                const mod = Math.floor((score - 10) / 2);
                const sign = mod >= 0 ? "+" : "";
                
                // Update the green Mod box
                document.getElementById(stat + 'Mod').innerText = sign + mod;

                // 2. Calculate the Saving Throw
                const isProficient = document.getElementById(stat + '-save-prof').checked;
                let saveTotal = mod;
                if (isProficient) {
                    saveTotal += profBonus;
                }
                const saveSign = saveTotal >= 0 ? "+" : "";

                // Update the blue Save box
                document.getElementById(stat + '-save').innerText = saveSign + saveTotal;
            }
        });

        // 3. Recalculate Skills (because Dex/Str/etc changed)
        if(typeof calcSkills === "function") {
            calcSkills(); 
        }
    }

    // 3. Calculate Skill Totals
    function calcSkills() {
        const profBonus = parseInt(document.getElementById('profBonus').value) || 2;

        skillList.forEach(skill => {
            const id = skill.name.replace(/\s+/g, '').toLowerCase();
            
            // Get Attribute Modifier (e.g., Dex Mod for Acrobatics)
            const attrScore = document.getElementById(skill.attr + 'Score').value;
            const attrMod = Math.floor((attrScore - 10) / 2);

            // Get Checkboxes
            const isProf = document.getElementById(id + '-prof').checked;
            const isExp = document.getElementById(id + '-exp').checked;
            const misc = parseInt(document.getElementById(id + '-misc').value) || 0;

            // Math: Attr + (Prof) + (Exp) + Misc
            let total = attrMod + misc;
            if (isProf) total += profBonus;
            if (isExp) total += profBonus; // Expertise adds PB again

            // Update UI
            document.getElementById(id + '-total').innerText = (total >= 0 ? "+" : "") + total;
        });
    }

    // --- SAVE / LOAD SYSTEM (Updated for Weapons) ---
    
    function saveData() {
        const data = {};
        // 1. Save standard inputs
        document.querySelectorAll('input, select').forEach(input => {
            if (input.id) { // Only save items with an ID
                if(input.type === 'checkbox') data[input.id] = input.checked;
                else data[input.id] = input.value;
            }
        });
        
        // 2. Save the Weapon List
        localStorage.setItem('dndSheetWeapons', JSON.stringify(weapons));
        
        // 3. Save the rest
        localStorage.setItem('dndSheetData', JSON.stringify(data));
        alert('Character Saved!');
    }

    function loadData() {
        initSkills(); // Build skills
        
        // 1. Load Standard Inputs
        const saved = localStorage.getItem('dndSheetData');
        if (saved) {
            const data = JSON.parse(saved);
            for (const [key, value] of Object.entries(data)) {
                const el = document.getElementById(key);
                if(el) {
                    if(el.type === 'checkbox') el.checked = value;
                    else el.value = value;
                }
            }
        }

        // 2. Load Weapons
        const savedWeapons = localStorage.getItem('dndSheetWeapons');
        if (savedWeapons) {
            weapons = JSON.parse(savedWeapons);
        }
        renderWeapons(); // Draw them on screen

        calcMods(); // Recalculate stats
    }

    // Start everything
    loadData();

    // --- SIMPLE EXPORT / IMPORT (No Password) ---

    // 1. EXPORT (Download File)
    function exportCharacter() {
        // A. Gather all data
        const data = {};
        document.querySelectorAll('input, select').forEach(input => {
            if (input.id) {
                if(input.type === 'checkbox') data[input.id] = input.checked;
                else data[input.id] = input.value;
            }
        });
        
        // Combine stats and weapons into one object
        const fullData = {
            stats: data,
            weapons: weapons // Uses your global weapons list
        };

        // B. Create JSON String
        const jsonString = JSON.stringify(fullData, null, 2); // Pretty print

        // C. Create Download
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // Name the file based on Character Name
        const charName = document.getElementById('charName').value || "Character";
        a.href = url;
        a.download = `${charName}.json`; 
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // 2. IMPORT (Load File)
    function importCharacter(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const parsedData = JSON.parse(content);

                // Load Stats
                if(parsedData.stats) {
                    for (const [key, value] of Object.entries(parsedData.stats)) {
                        const el = document.getElementById(key);
                        if(el) {
                            if(el.type === 'checkbox') el.checked = value;
                            else el.value = value;
                        }
                    }
                }
                
                // Load Weapons
                if(parsedData.weapons) {
                    weapons = parsedData.weapons;
                    renderWeapons();
                }
                
                // Refresh UI
                calcMods();
                alert("Character Loaded Successfully!");
                
            } catch (err) {
                alert("Error loading file: " + err.message);
            }
        };
        reader.readAsText(file);
        
        // Reset input so you can load the same file again if needed
        inputElement.value = '';
    }

</script>
</body>
</html>
